---
title: "Desconfio - Covid"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#librerías 
# stringr y stringi: para arreglar caracteres con acento 
#lubridate: para corregir problemas de fechas
#ggplot y plotly: para graficar
#dplyr, tidytext y tidyverse: manejo de fechas y datos
#rgdal, leaflet, htmlwidgets y htmltools: para mapas
#htmlwidgets, htmltools para usar elementos html
#wordcloud para nube de palabras
#DT para impresión de tablas
#hrbrthemes para paleta de colores
paquetes<-c("stringr","stringi", "lubridate", "ggplot2", "dplyr", "plotly", "rgdal", "leaflet", "htmlwidgets", "htmltools", "tidytext", "tidyverse", "wordcloud", "DT","hrbrthemes")

for(i in paquetes){
  if(!require(i, character.only = TRUE)){
    install.packages(i, dependencies=TRUE)
  }
  require(i, character.only = TRUE)  
}
```

## Proyecto Desconfío - Datos COVID 19

```{r, echo=FALSE}
#leo la base de datos
#setwd("C:/Users/Porotos/Documents/Desconfio_Covid/")
base <- read.csv("Base de datos.csv", sep= ",")

#primera mirada a los datos
#View(base)

#chequeo tipo de datos
#str(base)

original <- base

#cargo los datos de poblacion
poblacion <- read.csv("poblacion.csv",sep=";")
```

***

#### Verificación valores nulos

```{r, echo=FALSE}
#hay valores en blanco en lugar de NA. Arreglo eso
base[base==""]<-NA
nulos <- as.data.frame(apply(is.na(base),2,sum))
colnames(nulos) <- c("Cant_Valores_Nulos")

DT::datatable(nulos)
```

```{r, echo = FALSE}
#for(i in names(base)){
#  eval(parse(text=paste0("base$\"",i,"\"<-str_replace_all(stri_trans_general(original$\"",i,"\",id=\"latin-ascii\"), \"[^[:alnum:]]\", \" \")")))
#}
#names(base)<-stri_trans_general(names(base),id="latin-ascii")

#corrección del tipo de datos
#cambio el formato de fecha de texto a date
base$When.did.you.see.the.claim. <- as.Date(base$When.did.you.see.the.claim., format="%m/%d/%Y")

#hay dos fechas de Diciembre 2021 mal cargadas. Se corrigen a Dic 2020
base$When.did.you.see.the.claim.[base$When.did.you.see.the.claim. > Sys.Date()] <- "12-02-2020"

#cambio formato de pais a factor
base$Country.1 <- as.factor(base$Country.1)
base$Country.2 <- as.factor(base$Country.2)
base$Country.3 <- as.factor(base$Country.3)
base$Country.4 <- as.factor(base$Country.4)

#cambio organizacion a factor
base$Organization <- as.factor(base$Organization)

#cambio quien posteo a factor
base$Who.said.posted.it. <- as.factor(base$Who.said.posted.it.)

#cambio lenguaje a factor
base$Language.of.your.fact.check <- as.factor(base$Language.of.your.fact.check)

#cambio rating factor
base$Final.rating <- as.factor(base$Final.rating)

#cambio categoría a factor
base$Category <- as.factor(base$Category)

#importo base de paises para extraer continente
paises <- read.csv("https://pkgstore.datahub.io/JohnSnowLabs/country-and-continent-codes-list/country-and-continent-codes-list-csv_csv/data/b7876b7f496677669644f3d1069d3121/country-and-continent-codes-list-csv_csv.csv", sep = "," )
paises$nombre_corto <- stringr::str_split_fixed(paises$Country_Name,",",2)[,1]
paises <- paises[,c("Continent_Name", "nombre_corto")]

#corrijo algunos paises en el df de paises
paises$nombre_corto[paises$nombre_corto == "United Kingdom of Great Britain & Northern Ireland"] <- "United Kingdom"
paises$nombre_corto[paises$nombre_corto == "United States of America"] <- "United States"
paises[nrow(paises)+1, ] = c("Europe", "North Macedonia")
paises$nombre_corto[paises$nombre_corto == "Cote d'Ivoire"] <- "Ivory Coast"
paises$nombre_corto[paises$nombre_corto == "Russian Federation"] <- "Russia"
paises$nombre_corto[paises$nombre_corto == "Syrian Arab Republic"] <- "Syria"
paises$nombre_corto[paises$nombre_corto == "Slovakia (Slovak Republic)"] <- "Slovakia"
paises$nombre_corto[paises$nombre_corto == "Libyan Arab Jamahiriya"] <- "Libya"
paises$nombre_corto[paises$nombre_corto == "Kyrgyz Republic"] <- "Kyrgyzstan"
paises$nombre_corto[paises$nombre_corto == "Timor-Leste"] <- "Timor"

paises[nrow(paises)+1, ] <- c("Asia", "South Korea")
paises[nrow(paises)+1, ] <- c("Asia", "North Korea")
paises[nrow(paises)+1, ] <- c("Europe", "Kosovo")

#corrijo paises mal escritos en la base
base$Country.1[base$Country.1 == "UK"] <- "United Kingdom"
base$Country.1[base$Country.1 == "India "] <- "India"
base$Country.1[base$Country.1 == "DR Congo"] <- "Congo"
levels(base$Country.2) <- as.factor(c(levels(base$Country.2), "Congo"))
base$Country.2[base$Country.2 == "DR Congo"] <- "Congo"
base$Country.2[base$Country.2 == "USA"] <- "United States"
base$Country.2[base$Country.2 == "Spain "] <- "Spain"
base$Country.2[base$Country.2 == "Serbia "] <- "Serbia"
base$Country.2[base$Country.2 == "Croatia "] <- "Croatia"
base$Country.2[base$Country.2 == "Northern Ireland"] <- "United Kingdom"
levels(base$Country.2) <- as.factor(c(levels(base$Country.2), "Papua New Guinea"))
base$Country.2[base$Country.2 == "Papua-New-Guinea"] <- "Papua New Guinea"
levels(base$Country.3) <- as.factor(c(levels(base$Country.3), "Congo"))
base$Country.3[base$Country.3 == "DR Congo"] <- "Congo"
base$Country.3[base$Country.3 == "Serbia "] <- "Serbia"
base$Country.3[base$Country.3 == "Venezuela "] <- "Venezuela"
levels(base$Country.4) <- as.factor(c(levels(base$Country.4), "Congo"))
base$Country.4[base$Country.4 == "DR Congo"] <- "Congo"

#arreglo unos paises duplicados o que están en dos continentes
#caso contrario duplica a la hora del join
paises <- unique(paises)
paises <- paises[!(paises$Continent_Name == "Asia" & paises$nombre_corto == "Armenia"),]
paises <- paises[!(paises$Continent_Name == "Europe" & paises$nombre_corto == "Azerbaijan"),]
paises <- paises[!(paises$Continent_Name == "Asia" & paises$nombre_corto == "Cyprus"),]
paises <- paises[!(paises$Continent_Name == "Asia" & paises$nombre_corto == "Georgia"),]
paises <- paises[!(paises$Continent_Name == "Europe" & paises$nombre_corto == "Kazakhstan"),]
paises <- paises[!(paises$Continent_Name == "Asia" & paises$nombre_corto == "Russia"),]
paises <- paises[!(paises$Continent_Name == "Asia" & paises$nombre_corto == "Turkey"),]

#creo cuatro variables continente, 1 por pais
base <- dplyr::left_join(base, paises, by=c("Country.1" = "nombre_corto"), keep= FALSE, suffix=c("1","2"))
base <- dplyr::left_join(base, paises, by=c("Country.2" = "nombre_corto"), keep= FALSE, suffix=c("1","2"))
base <- dplyr::left_join(base, paises, by=c("Country.3" = "nombre_corto"), keep= FALSE, suffix=c("3","4"))
base <- dplyr::left_join(base, paises, by=c("Country.4" = "nombre_corto"), keep= FALSE, suffix=c("3","4"))

#reviso cuales quedaron sin dato
#View(base[is.na(base$Continent_Name2) & (base$Country.2 != ""),])
#View(base[is.na(base$Continent_Name2) & (base$Country.2 != ""),])

#arreglo los paises/areas sin continente
#campo country.1
base$Continent_Name1[base$Country.1 == "Middle East"] <- "Asia"
base$Continent_Name1[base$Country.1 == "Asia"] <- "Asia"
base$Continent_Name1[base$Country.1 == "Africa"] <- "Africa"
base$Continent_Name1[base$Country.1 == "North Africa"] <- "Africa"
base$Continent_Name1[base$Country.1 == "West Africa"] <- "Africa"
base$Continent_Name1[base$Country.1 == "Southern Africa"] <- "Africa"
base$Continent_Name1[base$Country.1 == "East Africa"] <- "Africa"
base$Continent_Name1[base$Country.1 == "Europe"] <- "Europe"
base$Continent_Name1[base$Country.1 == "South America"] <- "South America"
base$Continent_Name1[base$Country.1 == "North America"] <- "North America"

#campo country.2
base$Continent_Name2[base$Country.2 == "Middle East"] <- "Asia"
base$Continent_Name2[base$Country.2 == "Asia"] <- "Asia"
base$Continent_Name2[base$Country.2 == "Africa"] <- "Africa"
base$Continent_Name2[base$Country.2 == "North Africa"] <- "Africa"
base$Continent_Name2[base$Country.2 == "West Africa"] <- "Africa"
base$Continent_Name2[base$Country.2 == "Southern Africa"] <- "Africa"
base$Continent_Name2[base$Country.2 == "East Africa"] <- "Africa"
base$Continent_Name2[base$Country.2 == "Europe"] <- "Europe"
base$Continent_Name2[base$Country.2 == "South America"] <- "South America"
base$Continent_Name2[base$Country.2 == "North America"] <- "North America"

#campo country.3
base$Continent_Name3[base$Country.3 == "Middle East"] <- "Asia"
base$Continent_Name3[base$Country.3 == "Asia"] <- "Asia"
base$Continent_Name3[base$Country.3 == "Africa"] <- "Africa"
base$Continent_Name3[base$Country.3 == "North Africa"] <- "Africa"
base$Continent_Name3[base$Country.3 == "West Africa"] <- "Africa"
base$Continent_Name3[base$Country.3 == "Southern Africa"] <- "Africa"
base$Continent_Name3[base$Country.3 == "East Africa"] <- "Africa"
base$Continent_Name3[base$Country.3 == "Europe"] <- "Europe"
base$Continent_Name3[base$Country.3 == "South America"] <- "South America"
base$Continent_Name3[base$Country.3 == "North America"] <- "North America"

#campo country.4
base$Continent_Name4[base$Country.4 == "Central America"] <- "North America"

#arreglo campo WHO SAID POST IT para averiguar las redes sociales donde se posteo
#hay muchos errores de tipeo. Dada la cantidad de opciones disintas analizo las ppales. Hay mucho
# texto libre
base$Who.said.posted.it. <- toupper(base$Who.said.posted.it.)

#agrego columnas flag para determinar la red
base$facebook <- 0
base$twitter <- 0
base$whatsapp <- 0
base$instagram <- 0
base$youtube <- 0
base$socialmedia <- 0 
base$website <- 0
base$telegram <- 0

base$facebook <- base$facebook <- lapply(base$Who.said.posted.it., FUN=grepl, pattern=("FACEBOOK|FB"))
base$twitter <- lapply(base$Who.said.posted.it., FUN=grepl, pattern="TWITTER")
base$whatsapp <- lapply(base$Who.said.posted.it., FUN=grepl, pattern="WHATSAPP")
base$instagram <- lapply(base$Who.said.posted.it., FUN=grepl, pattern="INSTAGRAM")
base$youtube <- lapply(base$Who.said.posted.it., FUN=grepl, pattern="YOUTUBE")
base$socialmedia <- lapply(base$Who.said.posted.it., FUN=grepl, pattern="MEDIA")
base$website <- lapply(base$Who.said.posted.it., FUN=grepl, pattern="SITE")
base$telegram <- lapply(base$Who.said.posted.it., FUN=grepl, pattern="TELEGRAM")
```

```{r, echo=FALSE}
#verificación de valores únicos
#hay varias tablas que contienen valores idénticos duplicados (por ej. other, others, Other)

#table(base$Category)
base$Category[base$Category == "Conspiracy theory" | base$Category == "Conspiracy Theory"] <- "Conspiracy theories"
base$Category[base$Category == "Cure " | base$Category == "Cures" | base$Category == "Cures "] <- "Cure"
base$Category[base$Category == "other" | base$Category == "Other" | base$Category == "Prevention" ] <- "Others" 
base$Category[base$Category == "Symptoms "] <- "Symptoms" 

#elimino niveles no usados
base$Category <- factor(base$Category)

#en el campo final.rating se corrigen errores y se agrupan los menores en categoría "otros"
base$Final.rating <- toupper(base$Final.rating)
base$Final.rating[base$Final.rating == "MISLEADING " | base$Final.rating == "MISL" | base$Final.rating == " MISLEADING "] <- "MISLEADING" 
base$Final.rating[base$Final.rating == "FALSE "] <- "FALSE" 
base$Final.rating[base$Final.rating == "PARTLY FALSE" | base$Final.rating == "PARTLY FALSE " | base$Final.rating == "PARTLY FALSE"] <- "PARTIALLY FALSE" 
base$Final.rating[base$Final.rating == "NO EVIDENCE "] <- "NO EVIDENCE" 
base$Final.rating[base$Final.rating == "MAINLY FALSE"] <- "FALSE" 
base$Final.rating[base$Final.rating == "MISLEADING/FALSE" | base$Final.rating == "FALSE AND WITHOUT CONTEXT"] <- "FALSE" 
base$Final.rating[base$Final.rating == "MAINLY CORRECT" | base$Final.rating == "MOSTLY TRUE"] <- "PARTIALLY TRUE" 
base$Final.rating[base$Final.rating == "" | base$Final.rating == "(ORG. DOESN'T APPLY RATING)" | base$Final.rating == "EXPLANATORY" | base$Final.rating == "INACCURATE" | base$Final.rating == "UNPROVEN" | base$Final.rating == "UNSUPPORTED" ] <- "OTHERS" 

base$Final.rating <- factor(base$Final.rating)


#Arreglo la columna del idioma
base$Language.of.your.fact.check[base$Language.of.your.fact.check == "Brazil"] <- "Portuguese"
base$Language.of.your.fact.check[base$Language.of.your.fact.check == "english" | base$Language.of.your.fact.check == "English " | base$Language.of.your.fact.check == "Englsih"] <- "English"
base$Language.of.your.fact.check[base$Language.of.your.fact.check == "Georgian "] <- "Georgian"
base$Language.of.your.fact.check[base$Language.of.your.fact.check == "hindi"] <- "Hindi"
base$Language.of.your.fact.check[base$Language.of.your.fact.check == "korean"] <- "Korean"
base$Language.of.your.fact.check[base$Language.of.your.fact.check == "odia"] <- "Odia"
base$Language.of.your.fact.check[base$Language.of.your.fact.check == "spanish"] <- "Spanish"
base$Language.of.your.fact.check[base$Language.of.your.fact.check == "thai"] <- "Thai"

base$Language.of.your.fact.check <- factor(base$Language.of.your.fact.check)

```

### Período Evaluado 

`r min(base$When.did.you.see.the.claim.)`  hasta `r max(base$When.did.you.see.the.claim.)`

### Cantidad de Datos

Cantidad de registros analizados: `r nrow(base)`

Cantidad de variables analizadas: `r ncol(original)` (base de datos original - no incluye variables creadas para el análisis)


### Análisis Geográfico
#### Detalle por país


```{r, echo=FALSE}
#analisis por paises
#compilo el total de casos por país
total_x_pais <- rbind(as.data.frame(table(base$Country.1)), as.data.frame(table(base$Country.2)),as.data.frame(table(base$Country.3)),as.data.frame(table(base$Country.4)))
total_x_pais <- aggregate(total_x_pais$Freq, by=list(Var1 = total_x_pais$Var1), FUN=sum)

#cambio los nombres de las columnas y elimino valores nulos
colnames(total_x_pais) <- c("Pais", "Freq")
total_x_pais <- total_x_pais[total_x_pais$Pais != "", ]
total_x_pais <- total_x_pais[!is.na(total_x_pais$Pais), ]

#grafíco en plotly para que sea interactivo
graf_pais <- ggplot(total_x_pais[total_x_pais$Freq>200,], aes(x=Pais, y=Freq, fill=Freq)) +
              geom_bar(stat="identity") + 
              theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
              ggtitle("Cantidad de reportes por país (paises con más de 200 reportes)")

plotly::ggplotly(graf_pais)
```

#### Detalle por país c/100.000 habitantes

```{r, echo=FALSE}
#analisis por paises
#joineo c poblacion
total_x_pais_sd <- merge(total_x_pais, poblacion, by=c("Pais"))
total_x_pais_sd$cant_100k <- 100000 * total_x_pais_sd$Freq / total_x_pais_sd$Poblacion

#grafíco en plotly para que sea interactivo
graf_pais <- ggplot(total_x_pais_sd[total_x_pais_sd$cant_100k > 0.5,], aes(x=Pais, y=cant_100k, fill=cant_100k)) +
              geom_bar(stat="identity") + 
              theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
              ggtitle("Cantidad de reportes c/100.000 habitantes")

plotly::ggplotly(graf_pais)
```



```{r, echo=FALSE}
#analisis por paises
#compilo el total de casos por país
total_x_pais_latam <- rbind(as.data.frame(table(base$Country.1[base$Continent_Name1 == "South America"])), as.data.frame(table(base$Country.2[base$Continent_Name2 == "South America"])),as.data.frame(table(base$Country.3[base$Continent_Name3 == "South America"])),as.data.frame(table(base$Country.4[base$Continent_Name4 == "South America"])))
total_x_pais_latam <- aggregate(total_x_pais_latam$Freq, by=list(Var1 = total_x_pais_latam$Var1), FUN=sum)

#cambio los nombres de las columnas y elimino valores nulos
colnames(total_x_pais_latam) <- c("Pais", "Freq")
total_x_pais_latam <- total_x_pais_latam[total_x_pais_latam$Pais != "", ]
total_x_pais_latam <- total_x_pais_latam[!is.na(total_x_pais_latam$Pais), ]
total_x_pais_latam <- total_x_pais_latam[order(total_x_pais_latam$Freq),]


#grafíco en plotly para que sea interactivo
graf_pais <- ggplot(total_x_pais_latam, aes(x=reorder(Pais,-Freq), y=Freq, fill=Freq)) +
              geom_bar(stat="identity") + 
              theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1), 
                    axis.title.x=element_blank()) +
              ggtitle("América del Sur: Cantidad de reportes por país")

plotly::ggplotly(graf_pais)
```

#### Detalle cada 100.000 habitantes

```{r, echo=FALSE}
#analisis por paises
#joineo c poblacion
total_x_pais_latam_sd <- merge(total_x_pais_latam, poblacion, by=c("Pais"))
total_x_pais_latam_sd$cant_100k <- 100000 * total_x_pais_latam_sd$Freq / total_x_pais_latam_sd$Poblacion


#grafíco en plotly para que sea interactivo
graf_pais <- ggplot(total_x_pais_latam_sd, aes(x=reorder(Pais,-Freq), y=cant_100k, fill=cant_100k)) +
              geom_bar(stat="identity") + 
              theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1), 
                    axis.title.x=element_blank()) +
              ggtitle("América del Sur: Cantidad de reportes cada 100.000 habitantes")

plotly::ggplotly(graf_pais)
```


#### Detalle por País - Sudamérica

```{r, echo=FALSE}
DT::datatable(total_x_pais_latam_sd[order(-total_x_pais_latam_sd$cant_100k),], rownames = FALSE)
```

```{r, echo=FALSE, include=FALSE}
#modifico las columnas para armar el mapa
colnames(total_x_pais) <- c("name", "Freq")

#corrijo algunos paises para que no falle el joineo
#levels(total_x_pais$name) <- c(levels(total_x_pais$name), "Bosnia and Herz.", "Korea", "CÃ´te d'Ivoire","Dem. Rep. Korea","Czech Rep.","S. Sudan")
#total_x_pais$name[total_x_pais$name=="North Macedonia"] <- "Macedonia"
#total_x_pais$name[total_x_pais$name=="North Korea"] <- "Dem. Rep. Korea"
#total_x_pais$name[total_x_pais$name=="South Korea"] <- "Korea"
#total_x_pais$name[total_x_pais$name=="Bosnia and Herzegovina"] <- "Bosnia and Herz."
#total_x_pais$name[total_x_pais$name=="Singapore"] <- "Malaysia"
#total_x_pais$name[total_x_pais$name=="Czech Republic"] <- "Czech Rep."


#total_x_pais$name[total_x_pais$name=="Hong Kong"] <- "China"
#total_x_pais$name[total_x_pais$name=="Ivory Coast"] <- "CÃ´te d'Ivoire"
#total_x_pais$name[total_x_pais$name=="South Sudan"] <- "S. Sudan"
#total_x_pais$name[total_x_pais$name=="Bahrain"] <- "Qatar"
#total_x_pais$name[total_x_pais$name=="Timor"] <- "Timor-Leste"


#leo el mapa y joineo datos
countries_p <- readOGR("custom.geo.json")
#guardo el original para usarlo en el paso siguiente
countries <- countries_p
countries_p@data <- left_join(countries_p@data, total_x_pais, by=c("name"))


countries_p@data$Freq[countries_p@data$name == "Macedonia"] <- countries_p@data$Freq[countries_p@data$name == "Macedonia"] + total_x_pais$Freq[total_x_pais$name == "North Macedonia"]
countries_p@data$Freq[countries_p@data$name == "Korea"] <- total_x_pais$Freq[total_x_pais$name == "South Korea"]
countries_p@data$Freq[countries_p@data$name == "Dem. Rep. Korea"] <-total_x_pais$Freq[total_x_pais$name == "North Korea"]
countries_p@data$Freq[countries_p@data$name == "Bosnia and Herz."] <- total_x_pais$Freq[total_x_pais$name == "Bosnia and Herzegovina"]
countries_p@data$Freq[countries_p@data$name == "Malaysia"] <- countries_p@data$Freq[countries_p@data$name == "Malaysia"] + total_x_pais$Freq[total_x_pais$name == "Singapore"]
countries_p@data$Freq[countries_p@data$name == "Czech Rep."] <- total_x_pais$Freq[total_x_pais$name == "Czech Republic"]
countries_p@data$Freq[countries_p@data$name == "China"] <- countries_p@data$Freq[countries_p@data$name == "China"] + total_x_pais$Freq[total_x_pais$name == "Hong Kong"]
countries_p@data$Freq[countries_p@data$name == "CÃ´te d'Ivoire"] <- total_x_pais$Freq[total_x_pais$name == "Ivory Coast"]
countries_p@data$Freq[countries_p@data$name == "S. Sudan"] <- total_x_pais$Freq[total_x_pais$name == "South Sudan"]
countries_p@data$Freq[countries_p@data$name == "Qatar"] <- countries_p@data$Freq[countries_p@data$name == "Qatar"] + total_x_pais$Freq[total_x_pais$name == "Bahrain"]

countries_p@data$Freq[countries_p@data$name == "Timor-Leste"] <- total_x_pais$Freq[total_x_pais$name == "Timor"]


#hay paises definidos como regiones [medio oriente, africa, america del sur]
#arbitrariamente se redistribuyen los casos según los países más importantes de cada región

#region MIDDLE EAST se separa en IRAN, IRAQ, ARABIA y ARMENIA
countries_p@data$Freq[countries_p@data$name == "Armenia"] <- total_x_pais$Freq[total_x_pais$name == "Middle East"] / 4
countries_p@data$Freq[countries_p@data$name == "Iran"] <- total_x_pais$Freq[total_x_pais$name == "Middle East"] / 4 + countries_p@data$Freq[countries_p@data$name == "Iran"]
countries_p@data$Freq[countries_p@data$name == "Iraq"] <- total_x_pais$Freq[total_x_pais$name == "Middle East"] / 4 + countries_p@data$Freq[countries_p@data$name == "Iraq"]
countries_p@data$Freq[countries_p@data$name == "Saudi Arabia"] <- total_x_pais$Freq[total_x_pais$name == "Middle East"] / 4 + countries_p@data$Freq[countries_p@data$name == "Saudi Arabia"]


#region NORTH AFRICA se separa en Marruecos, Egipto, Lybia y Algeria
countries_p@data$Freq[countries_p@data$name == "Algeria"] <- total_x_pais$Freq[total_x_pais$name == "North Africa"] / 4 + countries_p@data$Freq[countries_p@data$name == "Algeria"]
countries_p@data$Freq[countries_p@data$name == "Morocco"] <- total_x_pais$Freq[total_x_pais$name == "North Africa"] / 4 + countries_p@data$Freq[countries_p@data$name == "Morocco"]
countries_p@data$Freq[countries_p@data$name == "Egypt"] <- total_x_pais$Freq[total_x_pais$name == "North Africa"] / 4 + countries_p@data$Freq[countries_p@data$name == "Egypt"]
countries_p@data$Freq[countries_p@data$name == "Libya"] <- total_x_pais$Freq[total_x_pais$name == "North Africa"] / 4 + countries_p@data$Freq[countries_p@data$name == "Libya"]

``` 


#### Mapa - Detalle por País

```{r, echo=FALSE}
#defino la paleta de colores
pal <- colorNumeric("Reds", NULL)

#defino los valores de los popup
state_popup <- paste0("<strong>Pais: </strong>", 
                      countries_p$name,
                      "<br><strong>Cantidad </strong>", 
                      countries_p$Freq)
#grafico el mapa
leaflet(countries_p) %>%
  addTiles() %>%
  addPolygons(stroke = FALSE, smoothFactor = 0.3, fillOpacity = 10,
              fillColor = ~pal(Freq), 
              popup = state_popup) %>%
  addLegend(pal = pal, values = ~(Freq), opacity = 1.0,
            labFormat = labelFormat(transform = function(x) round(x))) %>%
  setView(lng = -0, lat = -0, zoom = 1)
```

#### Estado de Situación en Sudamérica c/100.000 habitantes

```{r, echo=FALSE}
#grafico el mapa
#convierto en cero los que no son de sudamérica para mejorar la escala
countries_latam <- countries_p
countries_latam@data$Freq[countries_latam@data$region_un != "Americas"] <- 0
leaflet(countries_latam) %>%
  addTiles() %>%
  addPolygons(stroke = FALSE, smoothFactor = 0.3, fillOpacity = 1,
              fillColor = ~pal(100000*Freq/pop_est), 
              popup = state_popup) %>%
  addLegend(pal = pal, values = ~(0:8), opacity = 1.0,title = "Cantidad",
            labFormat = labelFormat(transform = function(x) round(x))) %>%
  setView(lng = -68, lat = -30, zoom = 3)
```

#### Detalle por continente

```{r, echo=FALSE}
#analisis por Continente
#agrupo totales por continente
total_x_cont <- rbind(as.data.frame(table(base$Continent_Name1)), as.data.frame(table(base$Continent_Name2)), as.data.frame(table(base$Continent_Name3)), as.data.frame(table(base$Continent_Name4)))
total_x_cont <- aggregate(total_x_cont$Freq, by=list(Var1 = total_x_cont$Var1), FUN=sum)

#cambio los nombres de las columnas para graficar
colnames(total_x_cont) <- c("continent", "Freq")

#agrego población con datos de wikipedia
total_x_cont$Pobl <- c(1320000000, 4701000000, 801000000, 550000000,40201000, 510000000)

total_x_cont$Cant_100k <- total_x_cont$Freq * 100000 / total_x_cont$Pobl

#imprimo el gráfico
graf_cont <- ggplot(total_x_cont, aes(x=continent, y=Freq, fill=Freq)) +
  geom_bar(stat="identity") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  ggtitle("Cantidad de casos por continente") +
  xlab("Continente")

plotly::ggplotly(graf_cont)

#imprimo el gráfico
graf_cont_sd <- ggplot(total_x_cont, aes(x=continent, y=Cant_100k, fill=Cant_100k)) +
  geom_bar(stat="identity") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  ggtitle("Cantidad de casos cada 100.000 habitantes") +
  xlab("Continente")

plotly::ggplotly(graf_cont_sd)
```

#### Mapa - Detalle por Continente

```{r, echo = FALSE}
#preparo los datos para imprimir el mapa
countries@data <- left_join(countries@data, total_x_cont, by=c("continent"))

#defino la paleta de colores y armo el mapa
pal <- colorNumeric("Reds", NULL)

#defino los valores de los popup
state_popup <- paste0("<strong>Continente: </strong>", 
                      countries$continent  ,
                      "<br><strong>Cantidad </strong>", 
                      countries$Freq)

leaflet(countries) %>%
  addTiles() %>%
  addPolygons(stroke = FALSE, smoothFactor = 0.3, fillOpacity = 1,
              fillColor = ~pal(Freq),
              popup = state_popup) %>%
  addLegend(pal = pal, values = ~Freq, opacity = 1.0,
            labFormat = labelFormat(transform = function(x) round(x))) %>%
  setView(lng = -0, lat = 0, zoom = 1)

```


#### Mapa - Detalle cada 100.000 habitantes - por Continente 

```{r, echo = FALSE}
#defino los valores de los popup
state_popup <- paste0("<strong>Continente: </strong>", 
                      countries$continent  ,
                      "<br><strong>Cantidad </strong>", 
                      countries$Freq,
                      "<br><strong>Cantidad c/100k hab. </strong>",
                      countries$Cant_100k
                      )

leaflet(countries) %>%
  addTiles() %>%
  addPolygons(stroke = FALSE, smoothFactor = 0.3, fillOpacity = 1,
              fillColor = ~pal(Cant_100k),
              popup = state_popup) %>%
  addLegend(pal = pal, values = ~(Cant_100k), title = "Cant c/100000 hab.", opacity = 1.0,
            labFormat = labelFormat(transform = function(x) round(x, digits = 2))) %>%
  setView(lng = -0, lat = 0, zoom = 1)

```

### Análisis por Organización reportante

```{r, echo = FALSE}

#analisis por organización reportante
#agrupo totales
total_x_fuente <- rbind(as.data.frame(table(base$Organization)))

#cambio los nombres de las columnas para graficar
colnames(total_x_fuente) <- c("Organizacion", "Freq")

#imprimo el gráfico
graf_fuente <- ggplot(total_x_fuente[total_x_fuente$Freq > 100,], aes(x=Organizacion, y=Freq, fill=Freq)) +
  geom_bar(stat="identity") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  ggtitle("Cantidad de reportes por Organización (más de 100 reportes)") +
  xlab("Organización Reportante")

plotly::ggplotly(graf_fuente)
```


### Noticias Chequeadas - Análisis por Palabra 
#### Top 10 palabras más usadas a nivel mundial

``` {r analisis_sentimientos, include=FALSE}
#Inicio analisis de palabras columna what.did.you.fact.check
#preparo los datos de la columna
fact_desc <- data.frame(base$What.did.you.fact.check.)
fact_desc <- tibble(text = fact_desc)
fact_desc <- mutate(fact_desc, text = text$base.What.did.you.fact.check.)

#separo por palabra
fact_desc_word <-  unnest_tokens(fact_desc, word, text)

#cargo los stop words
custom_stop_words <- bind_rows(stop_words, tibble(word = tm::stopwords("english"),lexicon = "custom"))
custom_stop_words <- custom_stop_words %>% add_row(word = "â", lexicon = "SMART")

#saco los stop words
fact_desc_word <- anti_join(fact_desc_word, custom_stop_words)

#cuento frecuencia de palabras
#fact_desc_word %>% count(word, sort = TRUE) 

#se unifican las distintas variantes para nombrar al COVID-19
fact_desc_word_v2 <- fact_desc_word

fact_desc_word_v2$word[(toupper(fact_desc_word_v2$word) == "COVID") | (toupper(fact_desc_word_v2$word) == "CORONA") | (toupper(fact_desc_word_v2$word) == "COVID19") | (toupper(fact_desc_word_v2$word) == "CORONAVIRUS")] <- "COVID-19"
#fact_desc_word_v2[fact_desc_word_v2$word != "19"]
```

#Imprimo la tabla de palabras
```{r, echo = FALSE}
#cuento frecuencia de palabras
palab2 <- fact_desc_word_v2 %>% count(word, sort = TRUE) 
palab2 <- palab2[-2,]
top10_palab <- head(palab2, n=10)
DT::datatable(top10_palab, rownames = FALSE, )
```

#### Palabras más usadas en los hechos chequeados

```{r grafico_frecuencia_palabras, echo=FALSE}
#grafico la frecuencia de palabras
palab2 %>%
  count(word, sort = TRUE) %>%
  filter(n > 300) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n)) +
  geom_col() +
  xlab(NULL) +
  coord_flip()
```

#### Mapa de palabras

```{r mapa_palabras, echo = FALSE}
#preparo un df para graficar
a <- palab2 %>%
   count(word)

wordcloud(words = a$word, freq = a$n, min.freq = 1, max.words=70,
           random.order=FALSE,scale=c(3,.6),
           colors=brewer.pal(8, "Dark2"))
``` 

#### Top 10 palabras más usadas en Sudamérica

``` {r analisis_sentimientos_latam, include=FALSE}
#Inicio analisis de palabras columna what.did.you.fact.check
#preparo los datos de la columna
fact_desc <- data.frame(base$What.did.you.fact.check.[base$Continent_Name1 == "South America" | base$Continent_Name2 == "South America" | base$Continent_Name3 == "South America" | base$Continent_Name4 == "South America"])

fact_desc <- tibble(text = fact_desc)
fact_desc <- mutate(fact_desc, text = text$base.What.did.you.fact.check.)

#separo por palabra
fact_desc_word <-  unnest_tokens(fact_desc, word, text)

#cargo los stop words
custom_stop_words <- bind_rows(stop_words, tibble(word = tm::stopwords("english"),lexicon = "custom"))
custom_stop_words <- custom_stop_words %>% add_row(word = "â", lexicon = "SMART")

#saco los stop words
fact_desc_word <- anti_join(fact_desc_word, custom_stop_words)

#cuento frecuencia de palabras
#fact_desc_word %>% count(word, sort = TRUE) 

#se unifican las distintas variantes para nombrar al COVID-19
fact_desc_word_v2 <- fact_desc_word
fact_desc_word_v2$word[(toupper(fact_desc_word_v2$word) == "COVID") | (toupper(fact_desc_word_v2$word) == "CORONA") | (toupper(fact_desc_word_v2$word) == "COVID19") | (toupper(fact_desc_word_v2$word) == "CORONAVIRUS")] <- "COVID-19"

#arreglo brazilian y brazil - arreglo sao paulo
fact_desc_word_v2$word[(toupper(fact_desc_word_v2$word) == "BRAZIL") | (toupper(fact_desc_word_v2$word) == "BRAZILIAN")] <- "BRAZILIAN"

fact_desc_word_v2$word[(toupper(fact_desc_word_v2$word) == "sã") | (toupper(fact_desc_word_v2$word) == "paulo")] <- "SAO_PAULO"

#fact_desc_word_v2[fact_desc_word_v2$word != "19"]
```

#Imprimo la tabla de palabras
```{r, echo = FALSE}
#cuento frecuencia de palabras
palab2 <- fact_desc_word_v2 %>% count(word, sort = TRUE) 
palab2 <- palab2[-c(1,3),]
top10_palab <- head(palab2, n=10)
DT::datatable(top10_palab, rownames = FALSE, )
```

```{r grafico_frecuencia_palabras_latam, echo=FALSE}
#grafico la frecuencia de palabras
palab2 %>%
  count(word, sort = TRUE) %>%
  filter(n > 75) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n)) +
  geom_col() +
  xlab(NULL) +
  coord_flip()
```

#### Mapa de palabras - Sudamérica

```{r mapa_palabras_latam, echo = FALSE}
#preparo un df para graficar
a <- palab2 %>%
   count(word)

wordcloud(words = a$word, freq = a$n, min.freq = 1, max.words=70,
           random.order=FALSE,scale=c(3,.6),
           colors=brewer.pal(8, "Dark2"))
```



#### Top 10 palabras más usadas en Bolivia

``` {r analisis_sentimientos_bolivia, include=FALSE}
#Inicio analisis de palabras columna what.did.you.fact.check
#preparo los datos de la columna
fact_desc <- data.frame(base$What.did.you.fact.check.[base$Country.1 == "Bolivia" | base$Country.2 == "Bolivia" | base$Country.3 == "Bolivia" | base$Country.4 == "Bolivia"])

fact_desc <- tibble(text = fact_desc)
fact_desc <- mutate(fact_desc, text = text$base.What.did.you.fact.check.)

#separo por palabra
fact_desc_word <-  unnest_tokens(fact_desc, word, text)

#cargo los stop words
custom_stop_words <- bind_rows(stop_words, tibble(word = tm::stopwords("english"),lexicon = "custom"))
custom_stop_words <- custom_stop_words %>% add_row(word = "â", lexicon = "SMART")

#saco los stop words
fact_desc_word <- anti_join(fact_desc_word, custom_stop_words)

#cuento frecuencia de palabras
#fact_desc_word %>% count(word, sort = TRUE) 

#se unifican las distintas variantes para nombrar al COVID-19
fact_desc_word_v2 <- fact_desc_word
fact_desc_word_v2$word[(toupper(fact_desc_word_v2$word) == "COVID") | (toupper(fact_desc_word_v2$word) == "CORONA") | (toupper(fact_desc_word_v2$word) == "COVID19") | (toupper(fact_desc_word_v2$word) == "CORONAVIRUS")] <- "COVID-19"

#arreglo BOLIVIA BOLIVIAN
fact_desc_word_v2$word[(toupper(fact_desc_word_v2$word) == "BOLIVIA") | (toupper(fact_desc_word_v2$word) == "BOLIVIAN")] <- "BOLIVIA"

#fact_desc_word_v2[fact_desc_word_v2$word != "19"]
```

```{r, echo = FALSE}
#cuento frecuencia de palabras
palab2 <- fact_desc_word_v2 %>% count(word, sort = TRUE) 
palab2 <- palab2[-c(1,3),]
top10_palab <- head(palab2, n=10)
DT::datatable(top10_palab)
```

```{r grafico_frecuencia_palabras_bolivia, echo=FALSE}
#grafico la frecuencia de palabras
palab2 %>%
  count(word, sort = TRUE) %>%
  mutate(word = reorder(word, n)) %>%
  filter(n > 4) %>%
  ggplot(aes(word, n)) +
  geom_col() +
  xlab(NULL) +
  coord_flip()
```

#### Mapa de palabras - Bolivia

```{r mapa_palabras_bolivia, echo = FALSE}
#preparo un df para graficar
a <- palab2 %>%
   count(word)

wordcloud(words = a$word, freq = a$n, min.freq = 1, max.words=70,
           random.order=FALSE,scale=c(3,.6),
           colors=brewer.pal(8, "Dark2"))
```

### Categoría por Continente

```{r, echo=FALSE}
#analizo las categorías por continente. Está bueno para ver que tipo de noticias circulan según 
#ideologías o problemas locales
categoria_x_continente <- as.data.frame(table(base$Category, base$Continent_Name1))

colnames(categoria_x_continente) <- c("Categoria", "Continente", "Freq")

p <- ggplot(categoria_x_continente,aes(x = Continente ,y = Freq)) + 
  geom_bar(aes(fill = Categoria),stat = "identity",position = "dodge") +
    theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))

plotly::ggplotly(p)

categoria_x_continente <- as.matrix(table(base$Category, base$Continent_Name1))

heatmap(categoria_x_continente, cexRow = 1, cexCol = 0.8, Colv = NA, Rowv = NA,scale = "column")
```

### Categoría en Sudamérica por País

```{r, echo=FALSE}
#analizo las categorías por continente. Está bueno para ver que tipo de noticias circulan según 
#ideologías o problemas locales
categoria_latam <- as.data.frame(table(base$Category[base$Continent_Name1=="South America"], base$Country.1[base$Continent_Name1=="South America"]))

colnames(categoria_latam) <- c("Categoria", "Pais", "Freq")

p <- ggplot(categoria_latam,aes(x = Pais ,y = Freq)) + 
  geom_bar(aes(fill = Categoria),stat = "identity",position = "dodge") +
    theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))

plotly::ggplotly(p)

categoria_latam <- as.matrix(table(base$Category, base$Continent_Name1))

heatmap(categoria_latam, cexRow = 1, cexCol = 0.8, Colv = NA, Rowv = NA,scale = "column")
```

### Idiomas

#### Idiomas de las noticias usados en más de 2 continentes distintos

```{r, echo = FALSE}
#analizo los idiomas que circulan por continente. Me detengo en aquellos que circulan por muchos continentes distintos
idiomas_x_continente <- as.data.frame(table(base$Continent_Name1, base$Language.of.your.fact.check))
cant_idiomas_distintos <- as.data.frame(table(idiomas_x_continente$Var2[idiomas_x_continente$Freq>0]))
colnames(cant_idiomas_distintos) <- c("Idioma", "Cant_Continentes")
idiomas <- cant_idiomas_distintos$Idioma[cant_idiomas_distintos$Cant_Continentes > 2]

#DT::datatable(cant_idiomas_distintos[cant_idiomas_distintos$Freq > 2,])

idiomas_usados <- subset(idiomas_x_continente, Var2 %in% idiomas)
colnames(idiomas_usados) <- c("Continente", "Idioma", "Freq")

p <- ggplot(idiomas_usados, aes(x = Continente, y = Idioma, fill = Freq)) + 
  geom_tile() +
  scale_fill_gradient(low="yellow", high="red") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) 

ggplotly(p, tooltip="text")
```

### Redes - Medio de Propagación

#### Redes sociales por las cuales se propagaron las noticias

```{r, echo = FALSE}
redes <- base[, c("Continent_Name1", "facebook", "twitter", "whatsapp", "youtube", "instagram", "socialmedia", "website", "telegram")]
redes_tabla <- gather(redes, "red", "usada", -Continent_Name1)
redes_tabla$usada[redes_tabla$usada == "FALSE"] <- 0
redes_tabla$usada[redes_tabla$usada == "TRUE"] <- 1
redes_tabla$usada <- as.vector(unlist(redes_tabla$usada))

total_redes <- aggregate(redes_tabla$usada, by=list(redes_tabla$Continent_Name1, redes_tabla$red), FUN=sum)
colnames(total_redes) <- c("Continente", "Red", "Freq")

p <- ggplot(total_redes, aes(x = Continente, y = Red, fill = Freq)) + 
  geom_tile() +
  scale_fill_gradient(low="yellow", high="red") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) 

ggplotly(p, tooltip="text")
```

#### Redes sociales por las cuales se propagaron las noticias
#### SUDAMERICA

```{r, echo = FALSE}
redes_latam <- base[base$Continent_Name1=="South America", c("Country.1", "facebook", "twitter", "whatsapp", "youtube", "instagram", "socialmedia", "website", "telegram")]
redes_tabla_latam <- gather(redes_latam, "red", "usada", -Country.1)
redes_tabla_latam$usada[redes_tabla_latam$usada == "FALSE"] <- 0
redes_tabla_latam$usada[redes_tabla_latam$usada == "TRUE"] <- 1
redes_tabla_latam$usada <- as.vector(unlist(redes_tabla_latam$usada))

total_redes_latam <- aggregate(redes_tabla_latam$usada, by=list(redes_tabla_latam$Country.1, redes_tabla_latam$red), FUN=sum)
total_redes_latam_soloRed <- aggregate(redes_tabla_latam$usada, by=list(redes_tabla_latam$red), FUN=sum)

colnames(total_redes_latam_soloRed) <- c("Red", "Freq")

total_redes_latam_soloRed <- total_redes_latam_soloRed[total_redes_latam_soloRed$Freq > 0,]

data <- total_redes_latam_soloRed %>% 
  mutate(per=`Freq`/sum(`Freq`)) %>% 
  arrange(desc(Red))
data$label <- scales::percent(data$per)

plot_ly(data=data,labels=~Red, values=~per, type="pie") %>% 
    layout(title = 'Sudamérica - Medio por el que se propagaron las noticias',
           xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
           yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))


#ggplot(data=data)+
#  geom_bar(aes(x="", y=per, fill=Red), stat="identity", width = 1)+
#  coord_polar("y", start=0)+
#  theme_void()+
#  geom_text(aes(x=1, y = cumsum(per) - per/2, label=label)) +
#  ggtitle("Sudamérica - Medio por el cual se propagaron las noticias")

#p <- ggplot(total_redes_latam, aes(x = Country.1, y = Red, fill = Freq)) + 
#  geom_tile() +
#  scale_fill_gradient(low="yellow", high="red") + 
#  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) 

#ggplotly(p, tooltip="text")
```

```{r, echo=FALSE}
redes_bolivia <- base[base$Country.1=="Bolivia", c("Country.1", "facebook", "twitter", "whatsapp", "youtube", "instagram", "socialmedia", "website", "telegram")]
redes_tabla_bolivia <- gather(redes_bolivia, "red", "usada", -Country.1)
redes_tabla_bolivia$usada[redes_tabla_bolivia$usada == "FALSE"] <- 0
redes_tabla_bolivia$usada[redes_tabla_bolivia$usada == "TRUE"] <- 1
redes_tabla_bolivia$usada <- as.vector(unlist(redes_tabla_bolivia$usada))

total_redes_bolivia <- aggregate(redes_tabla_bolivia$usada, by=list(redes_tabla_bolivia$Country.1, redes_tabla_bolivia$red), FUN=sum)
total_redes_bolivia_soloRed <- aggregate(redes_tabla_bolivia$usada, by=list(redes_tabla_bolivia$red), FUN=sum)

colnames(total_redes_bolivia_soloRed) <- c("Red", "Freq")

total_redes_bolivia_soloRed <- total_redes_bolivia_soloRed[total_redes_bolivia_soloRed$Freq > 0,]

data <- total_redes_bolivia_soloRed %>% 
  mutate(per=`Freq`/sum(`Freq`)) %>% 
  arrange(desc(Red))
data$label <- scales::percent(data$per)

plot_ly(data=data,labels=~Red, values=~per, type="pie") %>% 
    layout(title = 'Bolivia - Medio por el que se propagaron las noticias',
           xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
           yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))


#ggplot(data=data)+
#  geom_bar(aes(x="", y=per, fill=Red), stat="identity", width = 1)+
#  coord_polar("y", start=0)+
#  theme_void()+
#  geom_text(aes(x=1, y = cumsum(per) - per/2, label=label)) +
#  ggtitle("Bolivia - Medio por el cual se propagaron las noticias")

#p <- ggplot(total_redes_latam, aes(x = Country.1, y = Red, fill = Freq)) + 
#  geom_tile() +
#  scale_fill_gradient(low="yellow", high="red") + 
#  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) 

#ggplotly(p, tooltip="text")
```

